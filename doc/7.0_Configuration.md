# Operation & Configuration


## State
Blobcache stores all of it's data in a single directory called the "state dir".
The command line flag `--state <dir>` is usually how this parameter is set.

> Typically $HOME/.local/blobcache is used as the state dir.

The Blobcache daemon also stores configuration files in this directory.

A typical layout looks like this:

*Example 1*
```
pebble/             Directory for the pebble database. Metadata is stored in here.
blob/               Directory for the blobs.

IDENTITIES          Group file defining named groups of NodeIDs
ACTIONS             Group file defining named groups of actions
OBJECTS             Group files defining named groups of Volumes
GRANTS              File containing lists of grants
```

## Group Files
Blobcache authentication and authorization is managed using group files.
Group files are lists of group memberships.
Each line in a group file is a statement of the form *group `A` contains element `B`*, where `A` is the name of a group, and `B` is a description of something that the group contains.

As you can see above there are 3 group files and 1 grants file.

The first part of a group file line is always the group name.
The second part is a reference to a group if it starts with an `@`, and otherwise is parsed as a primitive element of the group.
See the example contents of each file below to get a better idea of how this looks in practice.

Group names can contain alphanumerics and `_`.

### Identities
The `IDENTITIES` file allows users to create named groups of Identities.
Each Identity is either a NodeID, or a reference to a group.


*Example 2*
```
my_laptop NNl0kKyillGqHtgVLevR-MkwJkWz7ry3ZpxEWEmzTZ-
my_desktop fnrwKB7Xd94r4156CCTmLskoDsrOewGPBGIwj8R1FuM
my_devices @my_laptop @my_desktop

admin @mydevices
```

### Actions
The `ACTIONS` file allows users to create lists of Actions.
Most users will not need to touch this file, a sensible list of default Action groups
is provided.

*Example 3*
```
all ACK INSPECT LOAD SAVE GET POST EXISTS DELETE LINK_FROM LINK_TO CREATE

read_only ACK INSPECT LOAD GET EXIST LINK_TO

write_add SAVE POST

write_delete DELETE

link LINK_FROM LINK_TO

admin @all
```

### Objects
The `OBJECTS` file allows users to create groupings of objects.

*Example 4*
```
volume_a FD9F440C84D8B60147274826FF51704E
volume_b AOBO0230FVBNWAHSDF00ANSDJFMBJKKD0

volumes_a_and_b @volume_a @volume_b
```

## Grants
The `GRANTS` file **is not** a group file.
But the user can reference groups defined in the group files from the `GRANTS` file.

Grants are what give Nodes the right to perform actions on other nodes.
This file is always initially empty, and Blobcache will refuse all incoming connections until there is a Grant referencing a user.

Each line in a grant file is structured as `<Subject> <Verb> <Object>`, where each part is separated from the other parts by whitespace.
Subject references the `IDENTITIES` group file.
Verb references the `ACTIONS` group file.
Object reference the `OBJECTS` group file.

Here is a snippet from a `GRANTS` file

*Example 5*
```
@admin_idens @admin_actions @all_objects
```

That line says that *the identities contained in the `admin_idens` group can perform any action contained in the `admin_actions` group on any object contained in the `all_objects` group*

The user could also forego the use of groups and write grants on single objects at a time.

*Example 6*
```

fnrwKB7Xd94r4156CCTmLskoDsrOewGPBGIwj8R1FuM LOAD FD9F440C84D8B60147274826FF51704E
fnrwKB7Xd94r4156CCTmLskoDsrOewGPBGIwj8R1FuM GET FD9F440C84D8B60147274826FF51704E
```

But as you can see, it's much more civilized to use named groups.

## Serving the API
Blobcache does not serve any API unless explicitly told to.
On a server machine, you probably don't want to expose the local API as there are no users on the server machine who need to act as that Blobcache Node.

On a laptop or desktop machine, a Blobcache Node is probably installed for applications running on the machine to act as the Node to access storage on other devices.

### HTTP API
The Local API is usually served over HTTP over a UNIX socket, although it can be served over any kind of stream socket, like TCP.
It is dangerous to serve the HTTP API to the network, as it allows any client to act as the Blobcache Node.

This parameter is controlled with the `--serve-api` flag.

*Example 7*
```
$ blobcache daemon-ephemeral --serve-api unix://./blobcache.sock
```

Over time, other methods of exposing the API may be added e.g. JSON RPC.

## Communicating with Peers
Blobcache Nodes communicate with other Nodes using the Blobcache Protocol (BCP).
This protocol listens for and initiates outbound connections from a single UDP socket, using the QUIC protocol as a transport layer.

*Example 8*
```
$ blobcache daemon-ephemeral --listen 0.0.0.0:6025
```

### Endpoints
Blobcache establishes connections to other Nodes on the network using Endpoints.
An Endpoint is a tuple `(NodeID, IP Address, Port)`.
Connections cannot be established without knowing the full Endpoint.
Blobcache does not perform any DNS resolution on endpoints, the IP address must be exactly specified.

> There is also a Blobcache URL format, which can be resolved into an Endpoint and Volume and is allowed to include domain names.

