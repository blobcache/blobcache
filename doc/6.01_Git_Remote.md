# Git Remote

Blobcache Volumes, being content-addressable stores themselves, work well with Git, which is built on it a content addressable store.

## Prerequisites
This guide assumes that you have blobcache running and the `BLOBCACHE_API` environment variable is set correctly.
You can verify that it has been set correctly with `blobcache endpoint`.


## How to Integrate with Git
First, some background. To integrate with Git, Blobcache ships a "git remote helper" (since v0.0.2), which is a specially named program that Git will automatically call when it needs to interact with a remote that it doesn't support natively (like a Blobcache remote).

Git remotes are primarily configured with their url.
A Blobcache Git URL looks something like this
```
bc::JcJvfY9tFsfkHSwoMT8IEoSq1ZfxVYBAwpBRvJ0uUJA:DAACDAF76B0CFFC0FA1498A35EBE1DFC
```

The `bc::` at the beginning tells Git to look for a program called `git-remote-bc` and call it with the URL as an argument.

We will come back to how to add a remote to Git, later.

## 1. Preparing a Volume
The Git Remote requires a Volume configured with the `sha2-256` hash algorithm.
This is one of the algorithms that Git can use, and is the only one which is considered secure at the time of writing.

Blobcache has a command for creating Git-suitable Volumes `git mkrepo`

```shell
$ blobcache git mkrepo
Volume successfully created.

HANDLE: 194EA0199098AD3801D7EEA721CBEC6F.5fb324d0af68330bb96d95b2fe7c8b49
```

> The handle contains secret information after the `.`, once the handle expires it is useless, so it's okay to share in an example like this.

Hang onto this handle, we will need to copy-paste it in the next step.

## 2. Persist the Volume
The Volume that was just created only has one handle.
Once that handle is gone, the volume is gone.
Volume handles expire after a few minutes, you can always make another one if it expires on you.
In order to keep the Volume around, which we want to do so we can store stuff in it, we need to add a link from the root Volume to it.

To do this we use the `blobcache ns put` command.

```
$ blobcache ns put mygitremote 194EA0199098AD3801D7EEA721CBEC6F.5fb324d0af68330bb96d95b2fe7c8b49
```

Now check that it worked.

```
blobcache ns ls
OID                             	RIGHTS  	NAME
194EA0199098AD3801D7EEA721CBEC6F	ALL     	mygitremote
```

You should see a volume with the same OID as the handle we created in step 1, and the name that you specified.

## 3. Add the Git Remote
At this point, we have a correctly configured Volume, suitable for Git.
Next we need to configure Git to access the Volume.
But first, we need to make sure the Git repository uses the correct hash function.
At the time of writing, Git uses the `sha1` by default, although this is expected to change in the near future.
For now (year 2025), you must manually tell Git to use the `sha256` hash function.

### Setup a Git Repository
It's probably safe to assume readers know how to use Git if they've gotten this far.

Just in case you want to follow along with exact steps.
These steps will set up a Git repository.
```shell
$ mkdir mynewgitrepo
$ cd mynewgitrepo
$ git init --object-format=sha256
```

To add a new remote to git:
```shell
$ git remote add myBlobcacheVolume bc::JcJvfY9tFsfkHSwoMT8IEoSq1ZfxVYBAwpBRvJ0uUJA:DAACDAF76B0CFFC0FA1498A35EBE1DFC
```

Then you should be able to push and pull refs.
If you have a branch `master`, push it like this
```
git push myBlobcacheVolume master
```

And this will perform a fetch, which means Git will download all the data from the remote, but will not merge it into any of your local branches.
```
git fetch myBlobcacheVolume
```
